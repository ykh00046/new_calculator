# Production Data Hub - Phase 4: AI ê¸°ë°˜ ìì—°ì–´ ë¶„ì„ ì‹œìŠ¤í…œ (AI Chat)

## 1. ê°œìš”
ë³¸ ê³„íšì€ ê¸°ì¡´ ìƒì‚° ë°ì´í„° ì‹œìŠ¤í…œì— **Generative AI (Gemini API)**ë¥¼ ì—°ë™í•˜ì—¬, ì‚¬ìš©ìê°€ ìì—°ì–´ë¡œ ë°ì´í„°ë¥¼ ì§ˆì˜í•˜ê³  ë¶„ì„ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.

**í•µì‹¬ ì›ì¹™:**
- **ë³´ì•ˆ:** API KeyëŠ” ë°±ì—”ë“œ(FastAPI)ì—ì„œë§Œ ê´€ë¦¬í•˜ë©°, í”„ë¡ íŠ¸ì—”ë“œ(UI)ëŠ” ì ˆëŒ€ LLMì— ì§ì ‘ ì ‘ê·¼í•˜ì§€ ì•ŠëŠ”ë‹¤.
- **ì‹ ë¢°ì„±:** LLMì˜ í™˜ê°(Hallucination)ì„ ë°©ì§€í•˜ê¸° ìœ„í•´, ë‹µë³€ì€ ë°˜ë“œì‹œ **APIê°€ ì¡°íšŒí•œ ì‹¤ì œ ë°ì´í„°**ì— ê·¼ê±°í•´ì•¼ í•œë‹¤. (Function Calling / Tool Use íŒ¨í„´)
- **ì¼ê´€ì„±:** DB Router(Archive + Live) ì •ì±…ì„ Tool í•¨ìˆ˜ì—ë„ ë™ì¼í•˜ê²Œ ì ìš©í•˜ì—¬ ë°ì´í„° ì •í•©ì„±ì„ ìœ ì§€í•œë‹¤.

---

## 2. ì•„í‚¤í…ì²˜ ë° ë°ì´í„° íë¦„

### 2.1 ì‹œìŠ¤í…œ êµ¬ì¡°
```mermaid
flowchart LR
    User[ì‚¬ìš©ì] -->|1.ì§ˆë¬¸ (JSON)| Streamlit[UI (Dashboard)]
    Streamlit -->|2.ì „ì†¡ (POST /chat)| FastAPI[API Server]
    
    FastAPI -->|3.ì˜ë„ íŒŒì•… ìš”ì²­| Gemini[Gemini API]
    Gemini -->|4.ì‹¤í–‰í•  í•¨ìˆ˜/íŒŒë¼ë¯¸í„° ë°˜í™˜| FastAPI
    
    FastAPI -->|5.DB ì¡°íšŒ(Router)| Archive/Live DB
    Archive/Live DB -->|6.ë°ì´í„° ë°˜í™˜| FastAPI
    
    FastAPI -->|7.ë°ì´í„° + ì§ˆë¬¸ ì „ì†¡| Gemini
    Gemini -->|8.ìì—°ì–´ ë‹µë³€ ìƒì„±| FastAPI
    
    FastAPI -->|9.ìµœì¢… ë‹µë³€ (JSON)| Streamlit
```

### 2.2 í´ë” êµ¬ì¡° ë³€ê²½
```text
C:\X\Server_v1\
â”œâ”€â”€ api\
â”‚   â”œâ”€â”€ main.py        # [ê¸°ì¡´] API ì§„ì…ì  (ë¼ìš°í„° ë“±ë¡)
â”‚   â”œâ”€â”€ chat.py        # [ì‹ ê·œ] AI ì±„íŒ… ì—”ë“œí¬ì¸íŠ¸ ë° ë¡œì§
â”‚   â””â”€â”€ tools.py       # [ì‹ ê·œ] DB ì¡°íšŒìš© ë‚´ë¶€ í•¨ìˆ˜ (LLM Tool)
â”œâ”€â”€ dashboard\
â”‚   â””â”€â”€ app.py         # [ìˆ˜ì •] AI ë¶„ì„ íƒ­ ì¶”ê°€
â””â”€â”€ .env               # [ì‹ ê·œ] GEMINI_API_KEY ì €ì¥
```

---

## 3. ìƒì„¸ êµ¬í˜„ ê³„íš (API First)

### 3.1 í™˜ê²½ ì„¤ì • (`.env` & `requirements.txt`)
- `google-generativeai`, `python-dotenv` ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€.
- `.env` íŒŒì¼ì— `GEMINI_API_KEY` ì„¤ì •.

### 3.2 Backend: ë„êµ¬(Tools) ì •ì˜ (`api/tools.py`)
LLMì´ í˜¸ì¶œí•  í•¨ìˆ˜ì…ë‹ˆë‹¤. **Phase 2ì˜ DB Router ë¡œì§**ì„ ê·¸ëŒ€ë¡œ ì ìš©í•˜ì—¬ 2025/2026 ë°ì´í„°ë¥¼ íˆ¬ëª…í•˜ê²Œ ì¡°íšŒí•©ë‹ˆë‹¤.

```python
def get_production_stats(date_from: str, date_to: str, item_code: str = None, aggregation: str = "sum"):
    """
    ì§€ì •ëœ ê¸°ê°„ì˜ ìƒì‚° ì‹¤ì  í†µê³„ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤. (Archive + Live í†µí•©)
    """
    # 1. ë‚ ì§œ ë²”ìœ„ì— ë”°ë¼ ëŒ€ìƒ DB ê²°ì • (Router)
    # 2. ATTACH DATABASE & UNION ALL ì¿¼ë¦¬ ì‹¤í–‰
    # 3. ì§‘ê³„ ê²°ê³¼ ë°˜í™˜
    return {"result": 150.5, "unit": "ea", "count": 10}
```

### 3.3 Backend: ì±„íŒ… ì—”ë“œí¬ì¸íŠ¸ (`api/chat.py`)
- **ìš”ì²­/ì‘ë‹µ í‘œì¤€í™”:** Pydantic ëª¨ë¸(`ChatRequest`, `ChatResponse`) ì‚¬ìš©.
- **ë°©ì–´ ë¡œì§:** ë„êµ¬ í˜¸ì¶œ(Function Call)ì´ ë°œìƒí•˜ì§€ ì•Šìœ¼ë©´ ë‹µë³€ì„ ê±°ë¶€í•˜ê±°ë‚˜ ì¬ì‹œë„.

```python
class ChatRequest(BaseModel):
    query: str
    session_id: str | None = None

class ChatResponse(BaseModel):
    status: str
    answer: str
    data_basis: dict | None = None # ê·¼ê±° ë°ì´í„°
```

### 3.4 Frontend: UI ì—°ë™ (`dashboard/app.py`)
- **[ğŸ¤– AI Analyst]** íƒ­ ì¶”ê°€.
- ì±„íŒ… UI (`st.chat_input`, `st.chat_message`) êµ¬í˜„.
- `requests.post`ë¡œ API ì„œë²„ì™€ JSON í†µì‹ .

---

## 4. ìš´ì˜ ë° ì•ˆì „ ì •ì±…

### 4.1 ë‹µë³€ ì›ì¹™ (System Prompt)
- "ë°ì´í„°ì— ê·¼ê±°í•´ì„œë§Œ ë‹µë³€í•´ë¼."
- "ì¡°íšŒ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ë¶ˆí™•ì‹¤í•˜ë©´ ì¶”ì¸¡í•˜ì§€ ë§ê³  'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'ë¼ê³  ë§í•´ë¼."
- "ë‹µë³€ì—ëŠ” ë°˜ë“œì‹œ ì§‘ê³„ ê¸°ì¤€(ê¸°ê°„, ëŒ€ìƒ)ì„ ëª…ì‹œí•´ë¼."

### 4.2 ë¡œê·¸ ë° ëª¨ë‹ˆí„°ë§
- ì‚¬ìš©ìì˜ ëª¨ë“  ì§ˆë¬¸ê³¼ ê·¸ì— ëŒ€í•´ ì‹œìŠ¤í…œì´ ìˆ˜í–‰í•œ ë‚´ë¶€ í•¨ìˆ˜(Tool) í˜¸ì¶œ ë‚´ì—­ì„ ë¡œê·¸ë¡œ ë‚¨ê¸´ë‹¤.

### 4.3 ì˜¤ë¥˜ ì²˜ë¦¬
- API Key ëˆ„ë½ ì‹œ: ì„œë²„ ê¸°ë™ ì‹œì ì— ì²´í¬í•˜ì—¬ ê²½ê³  ì¶œë ¥.
- LLM ì‘ë‹µ ì‹¤íŒ¨ ì‹œ: ì‚¬ìš©ìì—ê²Œ "ì¼ì‹œì ì¸ AI ì„œë¹„ìŠ¤ ì˜¤ë¥˜ì…ë‹ˆë‹¤"ë¼ê³  ì•ˆë‚´.

---

## 5. ì‹¤í–‰ ìŠ¤í…

1.  **ì¤€ë¹„:** ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜, API Key ë°œê¸‰.
2.  **Backend:** `api/tools.py` (DB ì—°ë™) -> `api/chat.py` (Gemini ì—°ë™) êµ¬í˜„.
3.  **í…ŒìŠ¤íŠ¸:** `/chat` ì—”ë“œí¬ì¸íŠ¸ ê²€ì¦.
4.  **Frontend:** UI ì—°ë™.